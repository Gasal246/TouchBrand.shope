<%-include('head.ejs')%>
<!-- EDIT PRODUCT FORM -->
<div>
    <div class="formDiv">
        <div class="row">
            <div class="col-12 mt-4 mb-3" style="display: flex; justify-content: space-between;">
                <h5><a href="/admin/products" style="text-decoration: none; color: #000;"><i
                            class="fa-solid fa-angle-left"></i> Back to Products</a></h5>
                </h5>
            </div>
        </div>
        <h6 class="text-center">Edit the product</h6>
        <form method="post" action="/admin/editproduct/<%= product._id %>" id="theEditForm" enctype="multipart/form-data">
            <div class="mb-3">
                <label class="form-label">Product Name</label>
                <input type="text" class="form-control" name="pname" id="pname" value="<%= product?product.Productname:'' %>" required>
            </div>
            <div class="mb-3">
                <label class="form-label">Category</label>
                <select name="category" id="category" class="form-control" required>
                    <option value="<%= product?product.Category:'' %>"><%= product?product.Category:'' %></option>
                    <% categories.map((category)=>{ %>
                        <option value="<%= category.Catname %>"><%= category.Catname %></option>
                    <% }) %>
                </select>
            </div>
            <div class="mb-3">
                <label class="form-label">Sub Categories</label>
                <input type="text" class="form-control" name="subcategory" id="editsubcategory" value="<%= product?product.SubCategory:'' %>" required>
            </div>
            <div class="mb-3">
                <label class="form-label">Specs</label>
                <input type="text" class="form-control" name="specs" id="specs" value="<%= product?product.Spec:'' %>" required>
            </div>
            <div class="form-floating mb-3">
                <textarea class="form-control" name="desc" placeholder="Leave a comment here" required
                    id="desc"><%= product?product.Description:'' %></textarea>
                <label for="desc">Description</label>
            </div>
            <div class="mb-3">
                <label class="form-label">Price</label>
                <input type="number" name="price" id="price" class="form-control" value="<%= product?product.Price:'' %>" required>
            </div>
            <div class="mb-3">
                <label class="form-label">Shipping cost</label>
                <input type="number" name="scost" id="scost" class="form-control" value="<%= product?product.Shipingcost:'' %>" required>
            </div>
            <div class="mb-3">
                <label class="form-label">Discount amount</label>
                <input type="number" name="discount" id="discount" class="form-control" value="<%= product?product.Discount:'' %>" required>
            </div>
            <div class="mb-3">
                <label class="form-label">Total stoke</label>
                <input type="number" name="stoke" id="stoke" class="form-control" value="<%= product?product.Stoke:'' %>" required>
            </div>
            <div class="mb-3">
                <label class="form-label">Select the images</label>
                <input type="file" class="form-control" id="editfileUpload" name="images" multiple>
            </div>
            <h6 class="errorDisplayer"></h6>
            <h6>click on images to remove it</h6>
            <div style="display: flex;">
                <% product.Imagepath.map((img)=>{ %>
                    <a onclick="deleteProductImage('<%= img %>', '<%= product._id %>')">
                        <img src="<%= img %>" class="m-1" alt="" style="width: 100px;">
                    </a>
                <% }) %>
            </div>
            <div id="editImagePreview">
            </div>
            <button type="submit" class="btn btn-primary">Edit product</button>
        </form>
    </div>
</div>
<script>
    function deleteProductImage(imageSrc, productid) {
            // AJAX request to update the quantity
            $.ajax({
                type: 'GET',
                url: `/admin/delproductimg/${encodeURIComponent(imageSrc)}/${productid}`,
                success: function (response) {
                    console.log('Image Deleted successfully: ', response);
                    // Update the total price and any other UI elements as needed
                    // For simplicity, let's reload the page to update the UI after quantity change
                    location.reload();
                },
                error: function (error) {
                    console.error('Error Deleting image: ', error);
                    location.reload();
                }
            });
        }
</script>
<script>
    const fileInput2 = document.getElementById('editfileUpload');
    const imagePreview2 = document.getElementById('editImagePreview');

    fileInput2.addEventListener('change', () => {
        imagePreview2.innerHTML = '';

        const files = fileInput2.files;
        for (let i = 0; i < files.length; i++) {
            const file = files[i];
            if (file.type.startsWith('image/')) {
                const img = document.createElement('img');
                img.className = 'preview-image';
                img.src = URL.createObjectURL(file);
                imagePreview2.appendChild(img);
            } else {
                fileInput2.value = ''
                document.querySelector('.errorDisplayer').innerHTML = "Only images allowed"
            }
        }
    });
</script>
<%-include('foot.ejs')%>